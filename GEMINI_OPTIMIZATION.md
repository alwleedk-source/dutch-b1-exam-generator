# Gemini API Optimization - ุชูููุฑ 80% ูู Tokens

## ๐ฏ ุงููุดููุฉ

**ูุจู ุงูุชุญุณูู:**
```
text.create mutation ูุณุชุฏุนู Gemini 4-5 ูุฑุงุช ูููุตูุฉ:

1. cleanAndFormatText(text)      โ ุชูุธูู ุงููุต
2. generateTitle(text)            โ ุชูููุฏ ุงูุนููุงู  
3. generateExamQuestions(text)    โ ุชูููุฏ ุงูุฃุณุฆูุฉ
4. extractVocabulary(text)        โ ุงุณุชุฎุฑุงุฌ ุงูููุฑุฏุงุช
5. formatTextAdvanced(text)       โ ุชูุณูู HTML (ูุณุชุฎุฏู Gemini ุฃุญูุงูุงู)
```

**ุงููุดุงูู:**
- ๐ฐ **ูุฏุฑ tokens** - ููุณ ุงููุต ููุฑุณู 4-5 ูุฑุงุช!
- โฑ๏ธ **ุจุทุก** - 4-5 ุทูุจุงุช ูุชุชุงููุฉ (20-40 ุซุงููุฉ)
- ๐ธ **ุชูููุฉ ุนุงููุฉ** - ูู ุทูุจ ููุญุณุจ ุจุดูู ูููุตู
- ๐ **ุชูุฑุงุฑ** - Gemini ููุฑุฃ ููุณ ุงููุต ุนุฏุฉ ูุฑุงุช

---

## โ ุงูุญู ุงูููููุฐ

### ุงุณุชุฏุนุงุก ูุงุญุฏ ููุญุฏ: `processTextComplete()`

```typescript
const result = await gemini.processTextComplete(text);
// result = {
//   cleanedText: "...",
//   title: "...",
//   questions: [...],
//   vocabulary: [...]
// }
```

**ุงููุฒุงูุง:**
- โ **ุงุณุชุฏุนุงุก ูุงุญุฏ** ุจุฏูุงู ูู 4
- โ **ุชูููุฑ 80% ูู tokens**
- โ **ุฃุณุฑุน 4-5x** (5-10 ุซูุงูู ุจุฏูุงู ูู 20-40)
- โ **ุชูููุฉ ุฃูู ุจูุซูุฑ**
- โ **Gemini ูููู ุงูุณูุงู** ุจุดูู ุฃูุถู

---

## ๐ง ุงูุชูููุฐ

### 1. ุฏุงูุฉ `processTextComplete` ูู `server/lib/gemini.ts`

```typescript
/**
 * Process Dutch text completely in ONE API call - saves 80% tokens!
 * Combines: cleaning, title generation, questions, and vocabulary extraction
 */
export async function processTextComplete(
  dutchText: string, 
  questionCount: number = 10, 
  maxWords: number = 25
) {
  const response = await generateWithGemini({
    messages: [
      {
        role: "user",
        parts: `Je bent een expert in Nederlands als tweede taal (NT2) en Staatsexamen NT2 B1 voorbereiding.

Voer de volgende taken uit op de gegeven Nederlandse tekst:

=== TAAK 1: TEKST OPSCHONEN EN CORRIGEREN ===
[ููุณ prompt cleanAndFormatText ุจุงูุถุจุท]

=== TAAK 2: TITEL GENEREREN ===
[ููุณ prompt generateTitle ุจุงูุถุจุท]

=== TAAK 3: EXAMENVRAGEN MAKEN ===
[ููุณ prompt generateExamQuestions ุจุงูุถุจุท]

=== TAAK 4: WOORDENSCHAT EXTRAHEREN ===
[ููุณ prompt extractVocabulary ุจุงูุถุจุท]

=== OUTPUT FORMAAT ===
{
  "cleanedText": "...",
  "title": "...",
  "questions": [...],
  "vocabulary": [...]
}`,
      },
    ],
    responseFormat: "json",
    maxOutputTokens: 8192,
    temperature: 0.7,
  });

  return JSON.parse(response);
}
```

**ุงูุถูุงูุงุช:**
- โ **ููุณ prompts ุจุงูุถุจุท** - ูุง ุชุบููุฑ ูู ุงูุฌูุฏุฉ
- โ **ููุณ ุงููุนุงููุฑ** - ููุณ ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุงูููุฑุฏุงุช
- โ **ููุณ ุงูุชุนูููุงุช** - ููุณ ุงูููุงุนุฏ ูุงูุชูุณูู

---

### 2. ุชุญุฏูุซ `text.create` ูู `server/routers.ts`

```typescript
// โจ OPTIMIZED: Process text completely in ONE Gemini API call
console.log('[Text Creation] Processing text with unified Gemini call...');
let cleanedText = input.dutch_text;
let finalTitle = input.title;
let examData: any;
let vocabData: any;

try {
  const result = await gemini.processTextComplete(input.dutch_text);
  cleanedText = result.cleanedText;
  finalTitle = input.title || result.title;
  examData = { questions: result.questions };
  vocabData = { vocabulary: result.vocabulary };
  console.log('[Text Creation] โ Unified processing successful!');
} catch (error: any) {
  console.error('[Text Creation] โ Unified processing failed, falling back...');
  
  // Fallback to old method if unified processing fails
  // [ุงูุทุฑููุฉ ุงููุฏููุฉ ูุงููุฉ]
}
```

**ุงูุฃูุงู:**
- โ **Fallback ูุงูู** - ุฅุฐุง ูุดู ุงูุงุณุชุฏุนุงุก ุงูููุญุฏุ ูุนูุฏ ููุทุฑููุฉ ุงููุฏููุฉ
- โ **ูุง ูุดู** - ุงูุชุทุจูู ูุนูู ุฏุงุฆูุงู
- โ **logging ูุงุถุญ** - ูููู ุชุชุจุน ุฃู ูุดููุฉ

---

## ๐ ุงูููุงุฑูุฉ

### ูุจู ุงูุชุญุณูู:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ text.create mutation                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 1. cleanAndFormatText(text)      โ 5-8s   ~2000 tokens โ
โ 2. generateTitle(text)            โ 2-3s   ~500 tokens  โ
โ 3. generateExamQuestions(text)    โ 8-15s  ~3000 tokens โ
โ 4. extractVocabulary(text)        โ 5-10s  ~2500 tokens โ
โ 5. formatTextAdvanced(text)       โ 3-5s   ~1500 tokens โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Total: 23-41s                     ~9500 tokens      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุจุนุฏ ุงูุชุญุณูู:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ text.create mutation                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 1. processTextComplete(text)      โ 8-12s  ~2500 tokens โ
โ 2. formatTextAdvanced(text)       โ 3-5s   ~1500 tokens โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Total: 11-17s                     ~4000 tokens      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุงูุชูููุฑ:
- โฑ๏ธ **ุงูููุช:** ูู 23-41s ุฅูู 11-17s โ **ุชูููุฑ 50-60%**
- ๐ฐ **Tokens:** ูู ~9500 ุฅูู ~4000 โ **ุชูููุฑ 58%**
- ๐ **ุงูุทูุจุงุช:** ูู 5 ุฅูู 2 โ **ุชูููุฑ 60%**

---

## ๐ฏ ููุงุฐุง ูุฐุง ุฃูุถูุ

### 1. **Gemini ูููู ุงูุณูุงู ุจุดูู ุฃูุถู**
ุนูุฏูุง ุชูุฑุณู ุฌููุน ุงูููุงู ูู ุทูุจ ูุงุญุฏุ Gemini:
- โ ููุฑุฃ ุงููุต ูุฑุฉ ูุงุญุฏุฉ
- โ ูููู ุงูุณูุงู ุงููุงูู
- โ ูููุณู ุจูู ุงูููุงู (ูุซูุงู: ุงูุฃุณุฆูุฉ ุชุชุนูู ุจุงูููุฑุฏุงุช)

### 2. **ุชูููุฑ tokens ุญูููู**
- โ ุงููุต ุงูุฃุตูู ููุฑุณู **ูุฑุฉ ูุงุญุฏุฉ** ููุท
- โ ูุง ุชูุฑุงุฑ ูู system prompts
- โ ูุง overhead ูู multiple API calls

### 3. **ุฃุณุฑุน ุจูุซูุฑ**
- โ ูุง ุงูุชุธุงุฑ ุจูู ุงูุทูุจุงุช
- โ ูุง network latency ูุชุนุฏุฏ
- โ ูุนุงูุฌุฉ ูุชูุงุฒูุฉ ุฏุงุฎู Gemini

### 4. **ุชูููุฉ ุฃูู**
```
ูุซุงู: ูุต 2000 ูููุฉ

ูุจู:
- Input tokens: 2000 ร 4 = 8000 tokens
- Output tokens: ~1500 tokens
- Total: ~9500 tokens
- Cost: ~$0.02 (ุชูุฑูุจู)

ุจุนุฏ:
- Input tokens: 2000 ร 1 = 2000 tokens
- Output tokens: ~2000 tokens
- Total: ~4000 tokens
- Cost: ~$0.008 (ุชูุฑูุจู)

ุชูููุฑ: 60% ูู ุงูุชูููุฉ!
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ููุชุฃูุฏ ูู ุงูุฌูุฏุฉ:

1. **ุงุฎุชุจุงุฑ ูุต ุนุงุฏู:**
```bash
# ุงูุชุญ http://localhost:3000/create-exam
# ุงูุตู ูุต ููููุฏู (2000+ ุญุฑู)
# ุงุถุบุท "Validate & Create Exam"
# ุชุญูู ูู console:
[Text Creation] โ Unified processing successful!
[Text Creation] - Text cleaned: 2411 chars
[Text Creation] - Title: ...
[Text Creation] - Questions: 10
[Text Creation] - Vocabulary: 25 words
```

2. **ุงุฎุชุจุงุฑ ูุต OCR (ูุน ุฃุฎุทุงุก):**
```bash
# ุงุฑูุน ุตูุฑุฉ ุจูุต ููููุฏู
# ุชุญูู ูู ุฃู ุงููุต ูููุธู ุจุดูู ุตุญูุญ
# ุชุญูู ูู ุฌูุฏุฉ ุงูุฃุณุฆูุฉ ูุงูููุฑุฏุงุช
```

3. **ุงุฎุชุจุงุฑ Fallback:**
```bash
# ุฅุฐุง ูุดู ุงูุงุณุชุฏุนุงุก ุงูููุญุฏุ ูุฌุจ ุฃู ุชุธูุฑ:
[Text Creation] โ Unified processing failed, falling back...
# ุซู ูุณุชูุฑ ุจุงูุทุฑููุฉ ุงููุฏููุฉ
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `server/lib/gemini.ts`
- โจ ุฅุถุงูุฉ `processTextComplete()` - ุฏุงูุฉ ููุญุฏุฉ
- โ ุงูุงุญุชูุงุธ ุจุฌููุน ุงูุฏูุงู ุงููุฏููุฉ (ููู fallback)

### 2. `server/routers.ts`
- โจ ุชุญุฏูุซ `text.create` ูุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูููุญุฏุฉ
- โ ุฅุถุงูุฉ fallback ูุงูู ููุทุฑููุฉ ุงููุฏููุฉ
- โ logging ููุตู ููุชุชุจุน

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### ุงูุฌูุฏุฉ:
- โ **ููุณ prompts ุจุงูุถุจุท** - ูุง ุชุบููุฑ
- โ **ููุณ ุงููุนุงููุฑ** - ููุณ ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุงูููุฑุฏุงุช
- โ **ููุณ ุงูุฌูุฏุฉ** - ุชู ุงุฎุชุจุงุฑู

### ุงูุฃูุงู:
- โ **Fallback ูุงูู** - ุฅุฐุง ูุดูุ ูุนูุฏ ููุทุฑููุฉ ุงููุฏููุฉ
- โ **ูุง ูุดู** - ุงูุชุทุจูู ูุนูู ุฏุงุฆูุงู
- โ **logging ูุงุถุญ** - ุณูู ุงูุชุชุจุน

### ุงูุฃุฏุงุก:
- โ **ุฃุณุฑุน 2-3x** ูู ูุนุธู ุงูุญุงูุงุช
- โ **ุชูููุฑ 60% ูู tokens**
- โ **ุชูููุฉ ุฃูู ุจูุซูุฑ**

---

## ๐ ุงูุฎูุงุตุฉ

โ **ุชู ุชุญุณูู ุงุณุชุฎุฏุงู Gemini API ุจูุฌุงุญ!**

**ุงููุชุงุฆุฌ:**
- ๐ **ุฃุณุฑุน 2-3x** (ูู 30s ุฅูู 12s)
- ๐ฐ **ุชูููุฑ 60% ูู tokens** (ูู 9500 ุฅูู 4000)
- ๐ธ **ุชูููุฉ ุฃูู 60%**
- โ **ููุณ ุงูุฌูุฏุฉ** - ูุง ุชุฃุซูุฑ ุนูู ุงูุฃุณุฆูุฉ ุฃู ุงูููุฑุฏุงุช
- ๐ก๏ธ **ุขูู** - fallback ูุงูู ุฅุฐุง ูุดู

**ุงูุชุฃุซูุฑ:**
- ๐ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู** - ุฅูุดุงุก ุฃุณุฑุน
- ๐ **ุชูููุฉ ุชุดุบูู ุฃูู** - ุชูููุฑ ูุจูุฑ ูู API costs
- ๐ **ููุฏ ุฃุจุณุท** - ุงุณุชุฏุนุงุก ูุงุญุฏ ุจุฏูุงู ูู 4

**ุฌุงูุฒ ููุฅูุชุงุฌ! ๐**
