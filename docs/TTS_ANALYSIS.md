# Text-to-Speech (TTS) - ุงูุชุญููู ูุงูุชุญุณูู

## ๐ฏ ุงูุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุชู

### โ ูู TTS ููุฌูุฏุ
**ูุนู!** TTS ููุฌูุฏ ููุนูู ุจุดูู ูุงูู.

### โ ูู ูุชู ุญูุธ ุงูุตูุช ูู R2ุ
**ูุนู!** ุงูุตูุช ููุญูุธ ูู R2 ุชููุงุฆูุงู.

### โ ูู ูุชู ุงุณุชุฏุนุงุก ุงูุตูุช ูู R2ุ
**ูุนู!** ูุชู ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูุช ูุจู ุงูุชูููุฏ.

---

## ๐ ููู ูุนูู ุงููุธุงู ุญุงููุงู

### 1. ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงูุณูุงุน ๐

```typescript
const handlePlayAudio = (word: any) => {
  if (word.audioUrl) {
    // โ ุงูุตูุช ููุฌูุฏ ูู R2 - ุชุดุบูู ูุจุงุดุฑ
    const audio = new Audio(word.audioUrl);
    audio.play();
  } else {
    // โ ุงูุตูุช ุบูุฑ ููุฌูุฏ - ุชูููุฏ ุฌุฏูุฏ
    generateAudioMutation.mutate({ 
      vocabId: word.id, 
      word: word.word 
    });
  }
};
```

**ุงูุณูุฑ:**
1. โ **ุงูุชุญูู:** ูู `audioUrl` ููุฌูุฏุ
2. โ **ุฅุฐุง ููุฌูุฏ:** ุชุดุบูู ูู R2 ูุจุงุดุฑุฉ (ูุง ุงุณุชููุงู TTS)
3. โ **ุฅุฐุง ุบูุฑ ููุฌูุฏ:** ุชูููุฏ ุฌุฏูุฏ + ุญูุธ ูู R2

---

## ๐ ุขููุฉ ุงูุชุฎุฒูู ูู R2

### ุนูุฏ ุชูููุฏ ุตูุช ุฌุฏูุฏ:

```typescript
// server/lib/tts.ts
export async function generateDutchSpeech(text: string) {
  // 1. ุงุณุชุฏุนุงุก Google Cloud TTS API
  const [response] = await client.synthesizeSpeech(request);
  
  // 2. ุชูููุฏ ุงุณู ููู ูุฑูุฏ
  const hash = Buffer.from(text).toString('base64').slice(0, 8);
  const filename = `tts/nl-NL/${hash}-${timestamp}.mp3`;
  
  // 3. ุฑูุน ุฅูู R2
  const audioUrl = await uploadToR2(filename, audioBuffer, 'audio/mpeg');
  
  // 4. ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  await db.updateVocabularyAudio(vocabId, audioUrl, audioKey);
  
  return { audioUrl, audioKey };
}
```

**ุงูุจููุฉ ูู R2:**
```
buildo-images/
โโโ tts/
    โโโ nl-NL/
        โโโ YWJjZGVm-1732208400.mp3  (ูููุฉ 1)
        โโโ eHl6MTIz-1732208500.mp3  (ูููุฉ 2)
        โโโ ...
```

---

## ๐ฐ ุชูููุฑ ุงูุชูููุฉ

### ุงูุขููุฉ ุงูุญุงููุฉ โ

```
ุงููุฑุฉ ุงูุฃููู:
User โ [Play] โ Check DB โ No audioUrl โ Generate TTS โ Upload R2 โ Save DB โ Play
                                          ๐ฐ $0.000016 (Google TTS)

ุงููุฑุฉ ุงูุซุงููุฉ:
User โ [Play] โ Check DB โ Has audioUrl โ Play from R2
                                          ๐ฐ $0 (ูุฌุงูู!)

ุงููุฑุฉ ุงูุซุงูุซุฉ:
User โ [Play] โ Check DB โ Has audioUrl โ Play from R2
                                          ๐ฐ $0 (ูุฌุงูู!)
```

**ุงูุชูููุฑ:**
- โ **ูู ูููุฉ ุชูููุฏ ูุฑุฉ ูุงุญุฏุฉ ููุท**
- โ **ุฌููุน ุงููุณุชุฎุฏููู ูุณุชุฎุฏููู ููุณ ุงูููู**
- โ **ูุง ุงุณุชููุงู ุฅุถุงูู ููู TTS**

---

## ๐ฏ ุงูุชุญุณููุงุช ุงูููุฌูุฏุฉ

### 1. โ Caching ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
vocabulary table:
- audioUrl: text       -- ุฑุงุจุท R2
- audioKey: varchar    -- ููุชุงุญ ุงูููู
```

**ุงููุฒุงูุง:**
- โ ุงูุชุญูู ุงูุณุฑูุน ูู ูุฌูุฏ ุงูุตูุช
- โ ูุง ุญุงุฌุฉ ูุชูููุฏ ูุฑุฉ ุฃุฎุฑู

### 2. โ Shared Vocabulary System
```typescript
// ููุณ ุงููููุฉ + ููุณ ุงูุณูุงู = ููุณ ุงูุตูุช
vocabulary_word_context_unique: uniqueIndex()
  .on(dutchWord, context)
```

**ุงููุฒุงูุง:**
- โ **ูููุฉ "bank" (financial)** โ ุตูุช ูุงุญุฏ ูุฌููุน ุงููุณุชุฎุฏููู
- โ **ูููุฉ "bank" (furniture)** โ ุตูุช ูุงุญุฏ ูุฌููุน ุงููุณุชุฎุฏููู
- โ ูุง ุชูุฑุงุฑ ูู ุงูุชูููุฏ

### 3. โ Lazy Loading
```typescript
// ุงูุตูุช ููููุฏ ููุท ุนูุฏ ุงูุทูุจ
if (word.audioUrl) {
  play(); // ูุจุงุดุฑุฉ
} else {
  generate(); // ุนูุฏ ุงูุญุงุฌุฉ ููุท
}
```

**ุงููุฒุงูุง:**
- โ ูุง ุชูููุฏ ูุณุจู ุบูุฑ ุถุฑูุฑู
- โ ุชูููุฏ ุญุณุจ ุงูุทูุจ ููุท

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชููุนุฉ

### ุณููุงุฑูู: 1000 ูููุฉ ูู ุงููุธุงู

**ุจุฏูู Caching:**
```
1000 ูููุฉ ร 100 ูุณุชุฎุฏู = 100,000 ุทูุจ TTS
ุงูุชูููุฉ: 100,000 ร $0.000016 = $1.60
```

**ูุน Caching (ุงูุญุงูู):**
```
1000 ูููุฉ ร 1 ูุฑุฉ ููุท = 1,000 ุทูุจ TTS
ุงูุชูููุฉ: 1,000 ร $0.000016 = $0.016
```

**ุงูุชูููุฑ: 99%!** ๐

---

## ๐ง ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ (ุงุฎุชูุงุฑูุฉ)

### 1. Pre-generate Audio ูููููุงุช ุงูุดุงุฆุนุฉ

```typescript
// ุนูุฏ ุฅูุดุงุก vocabulary ุฌุฏูุฏ
if (!existingVocab) {
  const newVocab = await db.createVocabulary({...});
  
  // โจ ุชูููุฏ ุงูุตูุช ูุจุงุดุฑุฉ (ูู ุงูุฎูููุฉ)
  generateDutchSpeech(word.dutch).then(({ audioUrl, audioKey }) => {
    db.updateVocabularyAudio(newVocab.id, audioUrl, audioKey);
  }).catch(err => console.error('Failed to pre-generate audio:', err));
}
```

**ุงููุฒุงูุง:**
- โ ุงูุตูุช ุฌุงูุฒ ุนูุฏ ุฃูู ุงุณุชุฎุฏุงู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู (ูุง ุงูุชุธุงุฑ)

**ุงูุนููุจ:**
- โ ูุฏ ููููุฏ ุตูุช ููููุงุช ูู ุชูุณุชุฎุฏู
- โ ุชูููุฉ ุฃุนูู ููููุงู

### 2. Batch Audio Generation

```typescript
// ุชูููุฏ ุตูุช ูุฌููุน ูููุงุช ุงููุต ุฏูุนุฉ ูุงุญุฏุฉ
async function generateAudioForText(textId: number) {
  const vocabulary = await db.getVocabularyByTextId(textId);
  
  for (const word of vocabulary) {
    if (!word.audioUrl) {
      const { audioUrl, audioKey } = await generateDutchSpeech(word.dutchWord);
      await db.updateVocabularyAudio(word.id, audioUrl, audioKey);
    }
  }
}
```

**ุงููุฒุงูุง:**
- โ ุฌููุน ุงููููุงุช ุฌุงูุฒุฉ
- โ ูุง ุงูุชุธุงุฑ ูููุณุชุฎุฏููู

**ุงูุนููุจ:**
- โ ููุช ุฃุทูู ูุฅูุดุงุก ุงูุงูุชุญุงู
- โ ุชูููุฉ ุฃุนูู

### 3. CDN Caching

```typescript
// ุฅุถุงูุฉ headers ููู caching
const audioUrl = await uploadToR2(filename, audioBuffer, 'audio/mpeg', {
  'Cache-Control': 'public, max-age=31536000', // ุณูุฉ ูุงููุฉ
  'Content-Type': 'audio/mpeg',
});
```

**ุงููุฒุงูุง:**
- โ ุชุญููู ุฃุณุฑุน ูู CDN
- โ ุชูููุฉ bandwidth ุฃูู

---

## ๐ฏ ุงูุชูุตูุงุช

### โ ุงููุธุงู ุงูุญุงูู ููุชุงุฒ!

**ูุง ุญุงุฌุฉ ูุชุบููุฑุงุช ูุจูุฑุฉ** ูุฃู:
1. โ **Caching ููุฌูุฏ** - ุงูุตูุช ููุญูุธ ูู R2
2. โ **Shared vocabulary** - ูุง ุชูุฑุงุฑ
3. โ **Lazy loading** - ุชูููุฏ ุนูุฏ ุงูุญุงุฌุฉ ููุท
4. โ **ุชูููุฑ 99%** ูู ุชูููุฉ TTS

### ๐ก ุชุญุณููุงุช ุงุฎุชูุงุฑูุฉ:

ุฅุฐุง ุฃุฑุฏุช ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู:
1. **Pre-generate audio** ูููููุงุช ุงูุดุงุฆุนุฉ (ุฃูู 100 ูููุฉ)
2. **Progress indicator** ุนูุฏ ุชูููุฏ ุงูุตูุช
3. **Retry mechanism** ุฅุฐุง ูุดู ุงูุชูููุฏ

---

## ๐ ุงูุฎูุงุตุฉ

### โ ูุง ูุนูู ุจุดูู ููุชุงุฒ:

| ุงูููุฒุฉ | ุงูุญุงูุฉ | ุงูุชูููุฑ |
|--------|--------|---------|
| TTS ููุฌูุฏ | โ ูุนู | - |
| ุญูุธ ูู R2 | โ ูุนู | - |
| Caching | โ ูุนู | 99% |
| Shared vocabulary | โ ูุนู | 99% |
| Lazy loading | โ ูุนู | - |

### ๐ฐ ุงูุชูููุฉ:

- **Google Cloud TTS:** $16 ููู ููููู ุญุฑู
- **ูููุฉ ูุชูุณุทุฉ:** 8 ุญุฑูู = $0.000128
- **ูุน Caching:** ูู ูููุฉ ุชูููุฏ ูุฑุฉ ูุงุญุฏุฉ ููุท
- **ุงูุชูููุฑ:** 99%

### ๐ ุงููุชูุฌุฉ:

**ุงููุธุงู ุงูุญุงูู ูุญุณูู ุจุดูู ููุชุงุฒ!**
- โ ูุง ุงุณุชููุงู ุฒุงุฆุฏ ููู TTS
- โ ุงูุตูุช ููุญูุธ ูููุณุชุฏุนู ูู R2
- โ ุชูููุฑ 99% ูู ุงูุชูููุฉ
- โ ูุง ุญุงุฌุฉ ูุชุญุณููุงุช ุนุงุฌูุฉ

**ุฌุงูุฒ ููุฅูุชุงุฌ! ๐**
